<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layout Editor - Draftosaurus</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .layout-editor {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-primary { background: #4caf50; color: white; }
        .btn-secondary { background: #757575; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-primary:hover { background: #388e3c; }
        .btn-secondary:hover { background: #616161; }
        .btn-danger:hover { background: #d32f2f; }
        .output-area {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
        }
        .output-area textarea {
            width: 100%;
            height: 200px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        .instructions h3 {
            margin-top: 0;
            color: #1976d2;
        }
        .instructions ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin: 5px 0;
        }
        .recinto, .subrecinto { display: inline-flex; flex-wrap: wrap; gap: var(--gap, 8px); padding: 8px; box-sizing: border-box; align-items: center; justify-content: center; overflow: hidden; }
        .recinto .slot, .subrecinto .slot { width: var(--slot-size, 60px); height: var(--slot-size, 60px); position: static !important; transform: none !important; flex: 0 0 auto; }
        .recinto.selected, .subrecinto.selected { outline: 2px dashed #2196f3; outline-offset: 2px; }
        #tablero { user-select: none; }
        /* Handle para redimensionar recintos */
        .recinto-resize-handle {
            position: absolute;
            right: -8px;
            bottom: -8px;
            width: 16px;
            height: 16px;
            background: rgba(76,175,80,0.95);
            border-radius: 50%;
            cursor: nwse-resize;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 6;
        }
    </style>
</head>
<body>
    <div class="layout-editor">
        <h1>Layout Editor - Posicionamiento de Recintos</h1>
        
        <div class="instructions">
            <h3>Instrucciones:</h3>
            <ul>
                <li><strong>Mover:</strong> Arrastra cualquier recinto con el mouse para posicionarlo</li>
                <li><strong>Tamaño slots:</strong> Selecciona un recinto y ajusta Tamaño/Gap abajo</li>
                <li><strong>Guardar:</strong> Copia el JSON generado y pásaselo al desarrollador</li>
                <li><strong>Reset:</strong> Vuelve a la posición original de todos los recintos</li>
            </ul>
        </div>

        <div class="controls">
            <button class="btn-primary" id="btnSaveLayout">Guardar Layout</button>
            <button class="btn-secondary" id="btnResetLayout">Reset Layout</button>
            <button class="btn-danger" id="btnClearOutput">Limpiar</button>
            <span style="margin-left:12px"></span>
            <label>Tamaño slot: <input type="number" id="inputSlotSize" value="60" min="20" max="200" style="width:80px"></label>
            <label>Gap: <input type="number" id="inputGap" value="8" min="0" max="40" style="width:80px"></label>
        </div>

        <div class="contenedor-tablero" id="tablero">
            <div class="recinto" id="LOVE_MEADOW" style="position: absolute; top: 80%; left: 20%; transform: translate(-50%, -50%);">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>

            <div class="recinto" id="LONELY" style="position: absolute; top: 80%; left: 80%; transform: translate(-50%, -50%);">
                <div class="slot"></div>
            </div>

            <div class="recinto" id="TRIO_TREES" style="position: absolute; top: 50%; left: 20%; transform: translate(-50%, -50%);">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>

            <div class="subrecinto" id="DIFFERENT_MEADOW" style="position: absolute; top: 50%; left: 80%; transform: translate(-50%, -50%);">
                <div class="slot" data-valor="1"></div>
                <div class="slot" data-valor="3"></div>
                <div class="slot" data-valor="6"></div>
                <div class="slot" data-valor="10"></div>
                <div class="slot" data-valor="15"></div>
                <div class="slot" data-valor="21"></div>
            </div>

            <div class="subrecinto" id="SAME_FOREST" style="position: absolute; top: 20%; left: 20%; transform: translate(-50%, -50%);">
                <div class="slot" data-valor="2"></div>
                <div class="slot" data-valor="4"></div>
                <div class="slot" data-valor="8"></div>
                <div class="slot" data-valor="12"></div>
                <div class="slot" data-valor="18"></div>
                <div class="slot" data-valor="24"></div>
            </div>

            <div class="recinto" id="KING" style="position: absolute; top: 20%; left: 80%; transform: translate(-50%, -50%);">
                <div class="slot"></div>
            </div>

            <div class="recinto" id="RIVER" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display:flex; flex-direction: column; gap: 10px;">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
        </div>

        <div class="output-area">
            <h3>JSON del Layout:</h3>
            <textarea id="layoutOutput" placeholder="Aquí aparecerá el JSON del layout cuando hagas clic en 'Guardar Layout'..."></textarea>
        </div>
    </div>

    <script>
        // Layout Editor Script
        (function initLayoutEditor(){
            const saveBtn = document.getElementById('btnSaveLayout');
            const resetBtn = document.getElementById('btnResetLayout');
            const clearBtn = document.getElementById('btnClearOutput');
            const output = document.getElementById('layoutOutput');
            const tablero = document.getElementById('tablero');
            
            if(!tablero) return;

            let startX=0, startY=0, origLeft=0, origTop=0;
            let current=null;       // recinto actual
            let dragging=false;

            // Hacer todos los recintos movibles y redimensionables
            function makeDraggable(el){
                el.style.cursor = 'move';
                el.addEventListener('mousedown', onDown);
                el.style.position = 'absolute';
                el.style.boxSizing = 'border-box';
                el.addEventListener('click', onSelectRecinto);
                addRecintoResizeHandle(el);
            }

            function onDown(e){
                // sólo drag de recinto, no del handle de resize
                if(e.target && e.target.classList && e.target.classList.contains('recinto-resize-handle')) return;
                current = e.currentTarget;
                // asegurar selección inmediata
                onSelectRecinto({ currentTarget: current });
                const rect = tablero.getBoundingClientRect();
                const curRect = current.getBoundingClientRect();
                startX = e.clientX;
                startY = e.clientY;
                // convertir a porcentajes
                origLeft = ((curRect.left - rect.left) / rect.width) * 100;
                origTop = ((curRect.top - rect.top) / rect.height) * 100;
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
                e.preventDefault();
                dragging = true;
            }

            function onMove(e){
                if(!current) return;
                const rect = tablero.getBoundingClientRect();
                const curRect = current.getBoundingClientRect();
                const dx = ((e.clientX - startX) / rect.width) * 100;
                const dy = ((e.clientY - startY) / rect.height) * 100;
                let left = origLeft + dx;
                let top = origTop + dy;
                // Limitar considerando el centro (translate -50%, -50%) y tamaño del elemento
                const widthPct = (curRect.width / rect.width) * 100;
                const heightPct = (curRect.height / rect.height) * 100;
                const minLeft = Math.max(0, widthPct / 2);
                const maxLeft = Math.min(100, 100 - widthPct / 2);
                const minTop = Math.max(0, heightPct / 2);
                const maxTop = Math.min(100, 100 - heightPct / 2);
                left = Math.max(minLeft, Math.min(maxLeft, left));
                top = Math.max(minTop, Math.min(maxTop, top));
                current.style.position = 'absolute';
                current.style.left = left + '%';
                current.style.top = top + '%';
                current.style.transform = 'translate(-50%, -50%)';
            }

            function onUp(){
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                current = null;
                dragging = false;
            }

            function onSelectRecinto(e){
                document.querySelectorAll('.recinto, .subrecinto').forEach(r=>r.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                const size = parseInt(getComputedStyle(e.currentTarget).getPropertyValue('--slot-size')) || 60;
                const gap = parseInt(getComputedStyle(e.currentTarget).getPropertyValue('--gap')) || 8;
                document.getElementById('inputSlotSize').value = size;
                document.getElementById('inputGap').value = gap;
                // Aplicar explícitamente los valores actuales al seleccionado para asegurar que existan variables
                e.currentTarget.style.setProperty('--slot-size', size + 'px');
                e.currentTarget.style.setProperty('--gap', gap + 'px');
            }

            function exportLayout(){
                const rect = tablero.getBoundingClientRect();
                const ids = ['LOVE_MEADOW','LONELY','TRIO_TREES','DIFFERENT_MEADOW','SAME_FOREST','KING','RIVER'];
                const data = {};
                ids.forEach(id=>{
                    const el = document.getElementById(id);
                    if(!el) return;
                    const style = getComputedStyle(el);
                    const left = parseFloat(style.left) || 0;
                    const top = parseFloat(style.top) || 0;
                    const width = el.offsetWidth / rect.width * 100;
                    const height = el.offsetHeight / rect.height * 100;
                    const slotSize = parseInt(style.getPropertyValue('--slot-size')) || 60;
                    const gap = parseInt(style.getPropertyValue('--gap')) || 8;
                    data[id] = { topPercent: top, leftPercent: left, widthPercent: width, heightPercent: height, slotSizePx: slotSize, gapPx: gap };
                });
                output.value = JSON.stringify(data, null, 2);
            }

            function resetLayout(){
                const recintos = [
                    {id: 'LOVE_MEADOW', top: 80, left: 20},
                    {id: 'LONELY', top: 80, left: 80},
                    {id: 'TRIO_TREES', top: 50, left: 20},
                    {id: 'DIFFERENT_MEADOW', top: 50, left: 80},
                    {id: 'SAME_FOREST', top: 20, left: 20},
                    {id: 'KING', top: 20, left: 80},
                    {id: 'RIVER', top: 50, left: 50}
                ];
                
                recintos.forEach(rec => {
                    const el = document.getElementById(rec.id);
                    if(el) {
                        el.style.position = 'absolute';
                        el.style.top = rec.top + '%';
                        el.style.left = rec.left + '%';
                        el.style.transform = 'translate(-50%, -50%)';
                        el.style.width = '';
                        el.style.height = '';
                    }
                });
                output.value = '';
            }

            // Inicializar
            const recintoIds = ['LOVE_MEADOW','LONELY','TRIO_TREES','DIFFERENT_MEADOW','SAME_FOREST','KING','RIVER'];
            recintoIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) makeDraggable(el);
            });

            // seleccionar el primero por defecto para que los controles funcionen
            const first = document.getElementById(recintoIds[0]);
            if(first){ onSelectRecinto({ currentTarget: first }); }

            // Event listeners
            saveBtn.addEventListener('click', exportLayout);
            resetBtn.addEventListener('click', resetLayout);
            clearBtn.addEventListener('click', () => output.value = '');

            // Controles de tamaño de slot y gap para recinto seleccionado
            const inputSlot = document.getElementById('inputSlotSize');
            const inputGap = document.getElementById('inputGap');
            function applySize(){
                const sel = document.querySelector('.recinto.selected, .subrecinto.selected');
                if(!sel) return;
                const size = Math.max(20, Math.min(200, parseInt(inputSlot.value)||60));
                const gap = Math.max(0, Math.min(40, parseInt(inputGap.value)||8));
                sel.style.setProperty('--slot-size', size + 'px');
                sel.style.setProperty('--gap', gap + 'px');
            }
            // también aplicar al cambiar (no solo input)
            inputSlot.addEventListener('change', applySize);
            inputGap.addEventListener('change', applySize);
            inputSlot.addEventListener('input', applySize);
            inputGap.addEventListener('input', applySize);

            // Redimensionar recintos con handle
            let resizingRecinto = false;
            let resizeStartX = 0, resizeStartY = 0, resizeStartW = 0, resizeStartH = 0, resizeTarget = null;
            function addRecintoResizeHandle(el){
                if(el.querySelector('.recinto-resize-handle')) return;
                const h = document.createElement('div');
                h.className = 'recinto-resize-handle';
                h.title = 'Redimensionar recinto';
                h.addEventListener('mousedown', function(e){
                    e.stopPropagation();
                    resizingRecinto = true;
                    resizeTarget = el;
                    const r = el.getBoundingClientRect();
                    resizeStartW = r.width;
                    resizeStartH = r.height;
                    resizeStartX = e.clientX;
                    resizeStartY = e.clientY;
                    document.addEventListener('mousemove', onRecintoResizeMove);
                    document.addEventListener('mouseup', onRecintoResizeUp);
                    // seleccionar el recinto
                    onSelectRecinto({ currentTarget: el });
                    e.preventDefault();
                });
                el.appendChild(h);
            }
            function onRecintoResizeMove(e){
                if(!resizingRecinto || !resizeTarget) return;
                const dx = e.clientX - resizeStartX;
                const dy = e.clientY - resizeStartY;
                let newW = Math.max(40, resizeStartW + dx);
                let newH = Math.max(40, resizeStartH + dy);
                // aplicar en px para que no afecte slot-size
                resizeTarget.style.width = newW + 'px';
                resizeTarget.style.height = newH + 'px';
            }
            function onRecintoResizeUp(){
                document.removeEventListener('mousemove', onRecintoResizeMove);
                document.removeEventListener('mouseup', onRecintoResizeUp);
                resizingRecinto = false;
                resizeTarget = null;
            }
        })();
    </script>
</body>
</html>
